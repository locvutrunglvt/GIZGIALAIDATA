<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o c√°o N√¥ng h·ªô</title>
    <style>
        /* C·∫§U H√åNH KH·ªî GI·∫§Y A4 */
        @page { size: A4; margin: 15mm; }
        body { font-family: 'Times New Roman', serif; font-size: 13px; line-height: 1.3; color: #000; background: #fff; }
        
        /* C·∫§U TR√öC B·∫¢NG */
        table { width: 100%; border-collapse: collapse; margin-bottom: 15px; page-break-inside: auto; }
        tr { page-break-inside: avoid; page-break-after: auto; }
        th, td { border: 1px solid black; padding: 4px 6px; vertical-align: middle; }
        .no-border td { border: none; }
        
        /* HEADER */
        .header-table { margin-bottom: 20px; }
        .header-title { font-size: 14pt; font-weight: bold; color: #38761d; text-transform: uppercase; }
        .report-title { font-size: 18pt; font-weight: bold; color: #b45f06; text-align: center; margin: 15px 0; text-transform: uppercase; }
        
        /* SECTION STYLES */
        .section-header { 
            background-color: #eee; 
            font-weight: bold; 
            padding: 5px; 
            margin-top: 20px; 
            border: 1px solid #000; 
            color: #783f04; 
            text-transform: uppercase; 
        }
        .bg-gray { background-color: #f3f3f3; font-weight: bold; text-align: center; }
        .text-center { text-align: center; }
        .text-bold { font-weight: bold; }
        
        /* TI·ªÜN √çCH LOADING */
        .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: flex; justify-content: center; align-items: center; font-size: 20px; z-index: 9999; flex-direction: column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { color: red; font-weight: bold; margin-top: 10px; text-align: center; padding: 0 20px;}
        
        /* ·∫®N KHI IN */
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>

    <div id="loading" class="loading">
        <div class="spinner"></div>
        <div id="loading-text">ƒêang k·∫øt n·ªëi d·ªØ li·ªáu n√¥ng h·ªô...</div>
        <div id="error-log" class="error-msg"></div>
    </div>

    <div class="no-print" style="text-align: center; padding: 10px; background: #f0f0f0; border-bottom: 1px solid #ccc; margin-bottom: 20px;">
        <button onclick="window.print()" style="padding: 10px 20px; font-size: 16px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px;">üñ®Ô∏è IN B√ÅO C√ÅO</button>
    </div>

    <table class="no-border header-table">
        <tr>
            <td style="width: 100%; text-align: left;">
                <div class="header-title">H·ªåC VI·ªÜN N√îNG NGHI·ªÜP VI·ªÜT NAM</div>
                <div class="header-title" style="font-size: 12pt;">VI·ªÜN KINH T·∫æ V√Ä TH·ªÇ CH·∫æ N√îNG NGHI·ªÜP</div>
            </td>
        </tr>
    </table>

    <div class="report-title">B·∫¢NG H·ªéI H·ªò N√îNG D√ÇN</div>

    <table>
        <tr>
            <td width="5%" class="text-center">1</td>
            <td width="25%">Ng√†y ph·ªèng v·∫•n</td>
            <td id="Interview_Date">...</td>
            <td width="20%" rowspan="6" class="text-center">
                 <img id="Respondent_Image" src="" alt="·∫¢nh ƒë·∫°i di·ªán" style="max-width: 100px; max-height: 120px; display: none; margin: auto;">
                <span id="img-placeholder">Ch∆∞a c√≥ ·∫£nh</span>
            </td>
        </tr>
        <tr>
            <td class="text-center">2</td>
            <td>T·ªânh</td>
            <td>Gia Lai</td>
        </tr>
        <tr>
            <td class="text-center">4</td>
            <td>X√£</td>
            <td id="Commune">...</td>
        </tr>
        <tr>
            <td class="text-center">5</td>
            <td>Th√¥n</td>
            <td id="Village">...</td>
        </tr>
        <tr>
            <td class="text-center">6</td>
            <td>T√™n ch·ªß h·ªô</td>
            <td id="Owner_Name" class="text-bold">...</td>
        </tr>
        <tr>
            <td class="text-center">7</td>
            <td>S·ªë ƒëi·ªán tho·∫°i</td>
            <td id="Phone_Number">...</td>
        </tr>
        <tr>
            <td class="text-center">8</td>
            <td>Ng∆∞·ªùi tr·∫£ l·ªùi PV</td>
            <td colspan="2" id="Respondent_Info">...</td>
        </tr>
        <tr>
            <td class="text-center">9</td>
            <td>Lo·∫°i h√¨nh kinh t·∫ø</td>
            <td colspan="2" id="Economic_Class">...</td>
        </tr>
        <tr>
            <td class="text-center">11</td>
            <td>S·ªë nƒÉm tr·ªìng c√† ph√™</td>
            <td colspan="2" id="Coffee_Years_Exp">...</td>
        </tr>
    </table>

    <div class="section-header">A. TH√îNG TIN TH√ÄNH VI√äN H·ªò</div>
    <table id="table-members">
        <thead>
            <tr class="bg-gray">
                <th>TT</th>
                <th>T√™n th√†nh vi√™n</th>
                <th>Gi·ªõi t√≠nh</th>
                <th>NƒÉm sinh</th>
                <th>D√¢n t·ªôc</th>
                <th>Quan h·ªá</th>
                <th>H·ªçc v·∫•n</th>
                <th>Tham gia SX?</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="section-header">B. THU NH·∫¨P GIA ƒê√åNH</div>
    <table>
        <tr class="bg-gray">
            <th>TT</th>
            <th colspan="2">N·ªôi dung</th>
            <th>ƒê∆°n v·ªã</th>
            <th>NƒÉm 2025</th>
        </tr>
        <tr>
            <td class="text-center">1</td>
            <td colspan="2"><b>T·ªïng thu nh·∫≠p r√≤ng</b></td>
            <td class="text-center">Tri·ªáu ƒë·ªìng</td>
            <td id="Total_Net_Income" class="text-center">...</td>
        </tr>
        <tr>
            <td></td>
            <td colspan="2">T·ª∑ tr·ªçng thu nh·∫≠p n√¥ng nghi·ªáp</td>
            <td class="text-center">%</td>
            <td id="Agri_Income_Pct" class="text-center">...</td>
        </tr>
        <tr>
            <td class="text-center">2</td>
            <td colspan="2"><b>Thu nh·∫≠p t·ª´ n√¥ng nghi·ªáp</b></td>
            <td class="text-center">Tri·ªáu ƒë·ªìng</td>
            <td id="Agri_Net_Income" class="text-center">...</td>
        </tr>
    </table>

    <div class="section-header">C. ƒê·∫§T ƒêAI & CANH T√ÅC</div>
    <table>
        <tr>
            <td width="5%" class="text-center">1</td>
            <td>T·ªïng di·ªán t√≠ch c√† ph√™ (ha)</td>
            <td id="Total_Coffee_Area">...</td>
        </tr>
        <tr>
            <td class="text-center">2</td>
            <td>S·ªë m·∫£nh v∆∞·ªùn</td>
            <td id="Plot_Quantity">...</td>
        </tr>
    </table>

    <p style="font-weight: bold; margin-top: 10px;">Th√¥ng tin chi ti·∫øt c√°c m·∫£nh ƒë·∫•t:</p>
    <table id="table-plots">
        <thead>
            <tr class="bg-gray">
                <th>M·∫£nh</th>
                <th>DT (ha)</th>
                <th>DT R·ª´ng</th>
                <th>S·ªë c√¢y</th>
                <th>Xen canh</th>
                <th>C√¢y xen</th>
                <th>NƒÉm tr·ªìng</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="section-header">D. T√ÄI CH√çNH N√îNG NGHI·ªÜP</div>
    <table>
        <tr>
            <td width="5%" class="text-center">1</td>
            <td>Ngu·ªìn vay v·ªën</td>
            <td id="Loan_Source">...</td>
        </tr>
        <tr>
            <td class="text-center">2</td>
            <td>Nhu c·∫ßu vay v·ªën EUDR?</td>
            <td id="Loan_need_EUDR">...</td>
        </tr>
    </table>

    <div class="section-header">G. TRUY XU·∫§T NGU·ªíN G·ªêC</div>
    <table>
        <tr>
            <td width="5%" class="text-center">1</td>
            <td>ƒê√£ √°p d·ª•ng truy xu·∫•t?</td>
            <td id="Trace_Applied_YN">...</td>
        </tr>
        <tr>
            <td class="text-center">2</td>
            <td>M√¥ t·∫£ h·ªá th·ªëng</td>
            <td id="Trace_System_Desc">...</td>
        </tr>
        <tr>
            <td class="text-center">3</td>
            <td>ƒê·ªô d·ªÖ √°p d·ª•ng</td>
            <td id="Trace_Ease_Score">...</td>
        </tr>
        <tr>
            <td class="text-center">4</td>
            <td>R√†o c·∫£n/Kh√≥ khƒÉn</td>
            <td id="Trace_Barriers">...</td>
        </tr>
    </table>

    <div class="section-header">H. CANH T√ÅC B·ªÄN V·ªÆNG</div>
    <table id="table-sustainable">
        <thead>
            <tr class="bg-gray">
                <th>TT</th>
                <th>Ph∆∞∆°ng th·ª©c/Ch·ª©ng ch·ªâ</th>
                <th>Bi·∫øt kh√¥ng?</th>
                <th>Th·ª±c h√†nh?</th>
                <th>ƒê∆∞·ª£c ch·ª©ng nh·∫≠n?</th>
                <th>Ai th·ª±c h√†nh?</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    
    <div class="section-header">J. ƒê√ÅNH GI√Å & NHU C·∫¶U H·ªñ TR·ª¢</div>
    <table>
        <tr>
            <td width="5%" class="text-center">1</td>
            <td>Kh√≥ khƒÉn l·ªõn nh·∫•t (EUDR)</td>
            <td id="EUDR_Max_Difficulty">...</td>
        </tr>
        <tr>
            <td class="text-center">2</td>
            <td colspan="2"><b>Mong mu·ªën h·ªó tr·ª£ t·ª´ d·ª± √°n SAFE:</b></td>
        </tr>
        <tr>
            <td></td>
            <td>Ph√°p l√Ω ƒë·∫•t ƒëai</td>
            <td id="Land_Legal">...</td>
        </tr>
        <tr>
            <td></td>
            <td>Truy xu·∫•t ngu·ªìn g·ªëc</td>
            <td id="Traceability_need">...</td>
        </tr>
        <tr>
            <td></td>
            <td>K·ªπ thu·∫≠t canh t√°c</td>
            <td id="Farm_Tech">...</td>
        </tr>
        <tr>
            <td></td>
            <td>K·∫øt n·ªëi doanh nghi·ªáp</td>
            <td id="Biz_Connect">...</td>
        </tr>
    </table>

    <script>
        // ============================================================
        // !!! QUAN TR·ªåNG: D√ÅN URL APPS SCRIPT C·ª¶A B·∫†N V√ÄO D√íNG D∆Ø·ªöI !!!
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwFchEzhV3NQ23F_cnUwSt3M0ZodDNCopx8EyZE2Tbe2HZTLqaKvjTbZtMhnvplKsBE/exec"; 
        // ============================================================

        async function loadData() {
            // 1. L·∫•y ID t·ª´ URL
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            const errorLog = document.getElementById('error-log');
            const loadingText = document.getElementById('loading-text');

            if (!id) { 
                loadingText.innerText = "L·ªói!";
                errorLog.innerText = "Kh√¥ng t√¨m th·∫•y ID n√¥ng d√¢n tr√™n ƒë∆∞·ªùng d·∫´n.\nH√£y ki·ªÉm tra l·∫°i Action trong AppSheet.";
                return; 
            }

            try {
                // 2. G·ªçi d·ªØ li·ªáu t·ª´ Google Apps Script
                const res = await fetch(SCRIPT_URL + "?id=" + id);
                
                // Ki·ªÉm tra l·ªói CORS ho·∫∑c l·ªói quy·ªÅn truy c·∫≠p
                const contentType = res.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    throw new Error("L·ªói k·∫øt n·ªëi: Apps Script ch∆∞a ƒë∆∞·ª£c set quy·ªÅn 'Anyone'.\nH√£y v√†o Script > Deploy > Who has access > Ch·ªçn 'Anyone'.");
                }

                const data = await res.json();
                
                if (data.error) { 
                    loadingText.innerText = "L·ªói d·ªØ li·ªáu!";
                    errorLog.innerText = "Server b√°o: " + data.error;
                    return; 
                }

                // 3. ƒêI·ªÄN D·ªÆ LI·ªÜU C∆† B·∫¢N V√ÄO C√ÅC √î C√ì ID TR√ôNG T√äN C·ªòT
                for (const key in data) {
                    const el = document.getElementById(key);
                    if (el) el.innerText = data[key];
                }

                // X·ª≠ l√Ω ri√™ng: Th√¥ng tin ng∆∞·ªùi tr·∫£ l·ªùi (G·ªôp t√™n + nƒÉm sinh)
                if (data.Respondent_Name) {
                    const prefix = (data.Gender === 'Nam') ? '√îng' : 'B√†';
                    document.getElementById('Respondent_Info').innerText = `${prefix} ${data.Respondent_Name} (${data['Year of birth'] || ''})`;
                }

                // X·ª≠ l√Ω ri√™ng: ·∫¢nh ƒë·∫°i di·ªán (n·∫øu c·ªôt Images c√≥ link)
                if (data.Images && data.Images !== "") {
                    // L∆∞u √Ω: N·∫øu link ·∫£nh AppSheet c·∫ßn ƒëƒÉng nh·∫≠p m·ªõi xem ƒë∆∞·ª£c th√¨ s·∫Ω b·ªã l·ªói.
                    // T·ªët nh·∫•t n√™n c·∫•u h√¨nh AppSheet Security > "Require Image Sign-in" = OFF
                    const imgEl = document.getElementById('Respondent_Image');
                    imgEl.src = data.Images;
                    imgEl.style.display = 'block';
                    document.getElementById('img-placeholder').style.display = 'none';
                }

                // 4. V·∫º B·∫¢NG CON: HH MEMBERS
                // L∆∞u √Ω: T√™n c·ªôt b√™n d∆∞·ªõi (Member_name, Gender...) ph·∫£i tr√πng ch√≠nh x√°c t√™n c·ªôt trong Google Sheet
                renderTable('table-members', data.HH_MEMBERS, [
                    'TT', 'Member_name', 'Gender', 'Year of birth', 'Ethlic', 'Relatives', 'Study level', 'Pember participate in coffee production'
                ]);

                // 5. V·∫º B·∫¢NG CON: LAND PLOTS
                renderTable('table-plots', data.LAND_PLOTS, [
                    'TT', 'Area_Ha', 'Forest area per plot', 'Tree_Count', 'Intercropping_YN', 'Tree_Intercropping', 'Start_Year'
                ]);

                // 6. V·∫º B·∫¢NG CON: SUSTAINABLE
                renderTable('table-sustainable', data.SUSTAINABLE, [
                    'TT', 'Certificate', 'Is_Known', 'Is_Practiced', 'Is_Certified', 'Who_Practices'
                ]);

                // T·∫Øt m√†n h√¨nh ch·ªù
                document.getElementById('loading').style.display = 'none';

            } catch (e) {
                console.error(e);
                loadingText.innerText = "L·ªói h·ªá th·ªëng!";
                errorLog.innerText = e.message;
            }
        }

        // H√†m h·ªó tr·ª£ v·∫Ω b·∫£ng
        function renderTable(tableId, rowData, columns) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            tbody.innerHTML = "";
            if (!rowData || rowData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${columns.length}" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`;
                return;
            }
            rowData.forEach(row => {
                let tr = "<tr>";
                columns.forEach(col => {
                    tr += `<td class="text-center">${row[col] || ''}</td>`;
                });
                tr += "</tr>";
                tbody.innerHTML += tr;
            });
        }

        // Ch·∫°y h√†m khi trang t·∫£i xong
        loadData();
    </script>
</body>
</html>
